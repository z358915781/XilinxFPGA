// -------------------------------------------------------------
// 
// File Name: D:\FPGA_MZ\FaultRey_VZ1\FaultRey_VZ1.v
// Created: 2024-02-19 22:17:47
// 
// Generated by MATLAB 9.1 and HDL Coder 3.9
// 
// 
// -- -------------------------------------------------------------
// -- Rate and Clocking Details
// -- -------------------------------------------------------------
// Model base rate: 4e-06
// Target subsystem base rate: 4e-06
// 
// -------------------------------------------------------------


// -------------------------------------------------------------
// 
// Module: FaultRey_VZ1
// Source Path: FaultRey_VZ1/FaultRey_VZ1
// Hierarchy Level: 0
// 
// -------------------------------------------------------------

`timescale 1 ns / 1 ns

module CBC_V1
	  (
	   input   g_clk,
	   input   Rst_n,
	   input   Pluse50Hz, 
	   input   PulseCarryx1_Hz, 
	   input   Work, 
	   input   OIins,
	   input   [3:0]  LockCnt, 
	   input   [15:0] MinLockTimeSet,		
	   output reg PwmLock,
	   output reg FaultLock, 
	   output reg [3:0] State 
	  ); 
   reg  [3:0]  FaultCnt; 
	reg  [15:0] MinLockTime;	
	always @(posedge g_clk) begin
		if(Work == 1'b1) begin//运行中
			if(State == 4'd0) begin //%work 
				if(OIins == 1'b1)  begin
					FaultCnt <= (FaultCnt<LockCnt) ? (FaultCnt+4'd1) : FaultCnt;
					State    <= (FaultCnt<LockCnt) ? 4'd1 : 4'd9;
					PwmLock  <= 1'b1;			
				end 
				else begin 
					FaultCnt <= Pluse50Hz ? 0 : FaultCnt; 
					PwmLock  <= 1'b0;  
				end 
				FaultLock <= 1'b0; 
				MinLockTime <= 0;
			end
			else if(State==4'd1) begin 
				MinLockTime <= (MinLockTime < MinLockTimeSet) ? (MinLockTime+1) : MinLockTime;  
				State       <= (MinLockTime < MinLockTimeSet) ? 4'd1 : 4'd2;  
				PwmLock     <= 1'b1; 
				FaultLock   <= 1'b0; 
			end 
			else if(State==4'd2) begin
				State     <= PulseCarryx1_Hz ? 4'd0 : State;  
				PwmLock   <= 1'b1; 
				FaultLock <= 1'b0; 
			end 
			else begin //%S9 fault lock
				PwmLock   <= 1'b1; 
				FaultLock <= 1'b1; 
			end
		end
		else begin //%not work
			State       <= 4'd0;
			PwmLock     <= 1'b0;
			FaultLock   <= 1'b0; 
			FaultCnt    <= 4'd0;
		end
	end

endmodule  // FaultRey_VZ1

